<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเตรียมข้อมูลส่ง SMS - โรงพยาบาลสัตว์สุราษฏร์ธานี</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f4f8; }
        .card { background-color: #ffffff; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.1); border: 1px solid #e5e7eb; }
        .form-input {
            width: 100%; border-radius: 0.75rem; border: 1px solid #d1d5db;
            padding: 0.75rem 1rem 0.75rem 2.75rem; transition: all 0.3s;
        }
        .form-input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); outline: none; }
        .input-with-icon { position: relative; }
        .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #9ca3af; }
        .swal2-popup { font-family: 'Sarabun', sans-serif; }
        .action-btn { background-color: transparent; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%; transition: background-color 0.2s; }
        .action-btn:hover { background-color: #e5e7eb; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 sm:px-6 py-4">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 text-center">
                <i class="fa-solid fa-paw text-blue-600"></i> ระบบแจ้งเตือน SMS โรงพยาบาลสัตว์
            </h1>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- SMS Data Entry Form -->
            <div class="card p-6 lg:p-8">
                <h2 id="form-title" class="text-2xl font-bold text-gray-800 mb-6 flex items-center transition-all">
                    <i class="fa-solid fa-file-pen mr-3 text-blue-600"></i>
                    <span>สร้างข้อความแจ้งเตือน</span>
                </h2>
                
                <form id="smsForm" class="space-y-6">
                    <input type="hidden" id="editRowNumber" name="editRowNumber">
                    <!-- Form fields -->
                    <div>
                        <label for="petName" class="block text-sm font-semibold text-gray-700 mb-2">ชื่อสัตว์เลี้ยง</label>
                        <div class="input-with-icon"><i class="fa-solid fa-dog input-icon"></i><input type="text" id="petName" name="petName" required placeholder="เช่น น้องนำโชค" class="form-input"></div>
                    </div>
                    <div>
                        <label for="phoneNumber" class="block text-sm font-semibold text-gray-700 mb-2">เบอร์ติดต่อ (10 หลัก)</label>
                        <div class="input-with-icon"><i class="fa-solid fa-mobile-screen-button input-icon"></i><input type="tel" id="phoneNumber" name="phoneNumber" required maxlength="10" pattern="[0-9]{10}" placeholder="0812345678" class="form-input"></div>
                    </div>
                    <div>
                        <label for="appointmentType" class="block text-sm font-semibold text-gray-700 mb-2">ประเภทนัดหมาย</label>
                        <div class="input-with-icon"><i class="fa-solid fa-syringe input-icon"></i>
                            <select id="appointmentType" name="appointmentType" required class="form-input appearance-none">
                                <option value="" disabled selected>กรุณาเลือกประเภทนัด...</option>
                                <option value="ฉีดวัคซีนรวมสุนัขและวัคซีนป้องกันโรคพิษสุนัขบ้า คำแนะนำ : งดอาบน้ำ 7 วัน">ฉีดวัคซีนรวมสุนัขและพิษสุนัขบ้า</option>
                                <option value="ฉีดวัคซีนรวมสุนัข คำแนะนำ : งดอาบน้ำ 7 วัน">ฉีดวัคซีนรวมสุนัข</option>
                                <option value="ฉีดวัคซีนรวมแมวและวัคซีนป้องกันโรคพิษสุนัขบ้า คำแนะนำ : งดอาบน้ำ 7 วัน">ฉีดวัคซีนรวมแมวและพิษสุนัขบ้า</option>
                                <option value="ฉีดวัคซีนรวมแมว คำแนะนำ : งดอาบน้ำ 7 วัน">ฉีดวัคซีนรวมแมว</option>
                                <option value="ฉีดวัคซีนป้องกันโรคพิษสุนัขบ้า คำแนะนำ : งดอาบน้ำ 7 วัน">ฉีดวัคซีนป้องกันโรคพิษสุนัขบ้า</option>
                                <option value="ฉีดวัคซีนลิวคีเมีย คำแนะนำ : งดอาบน้ำ 7 วัน">ฉีดวัคซีนลิวคีเมีย</option>
                                <option value="ตรวจเลือดหาเชื้อไวรัสก่อนฉีดวัคซีนลิวคีเมีย คำแนะนำ : งดอาบน้ำ 7 วัน">ตรวจเลือดก่อนฉีดวัคซีนลิวคีเมีย</option>
                                <option value="ฉีดวัคซีน คำแนะนำ : งดอาบน้ำ 7 วัน">ฉีดวัคซีน (ทั่วไป)</option>
                                <option value="ดูอาการต่อเนื่อง">ดูอาการต่อเนื่อง</option>
                                <option value="รับยาต่อเนื่อง">รับยาต่อเนื่อง</option>
                                <option value="ฉีดยา">ฉีดยา</option>
                                <option value="ฉีดยาคุม">ฉีดยาคุม</option>
                                <option value="ตัดไหม">ตัดไหม</option>
                                <option value="ตรวจเลือด">ตรวจเลือด</option>
                                <option value="ทำหมัน">ทำหมัน</option>
                                <option value="ทำแผล">ทำแผล</option>
                                <option value="ครบรอบกินยา NEXGARD / NEXGARD SPECTRA ต่อเนื่อง">ครบรอบกินยา NEXGARD / SPECTRA</option>
                                <option value="ครบรอบกินยา BRAVECTO ต่อเนื่อง">ครบรอบกินยา BRAVECTO</option>
                                <option value="ครบรอบหยอดยา ADVOCATE / NEXGARD COMBO ต่อเนื่อง คำแนะนำ : ก่อนและหลังหยอดยางดอาบน้ำ 2 วัน">ครบรอบหยอดยา ADVOCATE / COMBO</option>
                                <option value="ครบรอบหยอดยาเห็บหมัด ต่อเนื่อง คำแนะนำ : ก่อนและหลังหยอดยางดอาบน้ำ 2 วัน">ครบรอบหยอดยาเห็บหมัด</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="sendDate" class="block text-sm font-semibold text-gray-700 mb-2">วันที่ส่ง SMS</label>
                         <div class="input-with-icon"><i class="fa-solid fa-calendar-days input-icon"></i><input type="date" id="sendDate" name="sendDate" required class="form-input"></div>
                    </div>

                    <!-- Action Buttons -->
                    <div id="form-actions" class="pt-4 grid grid-cols-2 gap-4">
                        <button type="button" id="clearBtn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center text-lg">
                            <i class="fa-solid fa-eraser mr-2"></i><span id="clearBtn-text">ล้างข้อมูล</span>
                        </button>
                        <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105 shadow-lg flex items-center justify-center text-lg">
                            <i id="submitBtn-icon" class="fa-solid fa-paper-plane mr-2"></i><span id="submitBtn-text">บันทึก</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Dashboard Section -->
            <div class="card p-6 lg:p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                     <i class="fa-solid fa-clock-rotate-left mr-3 text-blue-600"></i>
                    รายการล่าสุด
                </h2>
                <div id="dashboard" class="space-y-4">
                    <div class="text-center py-8"><i class="fa-solid fa-spinner fa-spin text-4xl text-blue-500"></i><p class="text-gray-500 mt-4">กำลังโหลดข้อมูล...</p></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwwtzEUk2yuCCoxrd53YRXfgN9cP6rtr3ixeLr9iD7aRNjuvx9TMk76Rq50hPpvYuyV/exec"; 
        const GVIZ_URL = "https://docs.google.com/spreadsheets/d/1UltCx_5u19F675ELpi7OUAxQJFh6UkbD6Qq__jQoL5Q/gviz/tq?tqx=out:json&sheet=DATA";

        // --- DOM ELEMENTS ---
        const form = document.getElementById('smsForm');
        const dashboard = document.getElementById('dashboard');
        
        // --- APP STATE ---
        const appState = {
            isEditing: false,
            editingRowNumber: null,
        };

        // --- HELPER FUNCTIONS ---
        function convertToBuddhistEra(gregorianDate) {
            if (!gregorianDate) return '';
            const date = new Date(gregorianDate);
            const buddhistYear = date.getFullYear() + 543;
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${day}/${month}/${buddhistYear}`;
        }

        function convertBuddhistToGregorian(buddhistDate) {
            if (!buddhistDate || !buddhistDate.includes('/')) return '';
            const parts = buddhistDate.split('/');
            const gregorianYear = parseInt(parts[2], 10) - 543;
            if (isNaN(gregorianYear)) return '';
            return `${gregorianYear}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
        }
        
        function formatRelativeTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            if (seconds < 60) return "เมื่อสักครู่";
            const intervals = {ปี: 31536000, เดือน: 2592000, วัน: 86400, ชั่วโมง: 3600, นาที: 60};
            for (const [unit, secondsPerUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsPerUnit);
                if (interval >= 1) return `เมื่อ ${interval} ${unit}ที่แล้ว`;
            }
            return "เมื่อสักครู่";
        }

        // --- UI UPDATE FUNCTIONS ---
        function updateFormUI() {
            const titleIcon = document.querySelector('#form-title i');
            const titleText = document.querySelector('#form-title span');
            const clearBtnText = document.getElementById('clearBtn-text');
            const submitBtn = document.getElementById('submitBtn');
            const submitBtnText = document.getElementById('submitBtn-text');
            const submitBtnIcon = document.getElementById('submitBtn-icon');

            if (appState.isEditing) {
                titleIcon.className = 'fa-solid fa-pencil mr-3 text-amber-500';
                titleText.textContent = 'แก้ไขข้อมูล';
                submitBtnText.textContent = 'อัปเดตข้อมูล';
                submitBtnIcon.className = 'fa-solid fa-floppy-disk mr-2';
                submitBtn.classList.replace('bg-blue-600', 'bg-amber-500');
                submitBtn.classList.replace('hover:bg-blue-700', 'hover:bg-amber-600');
                clearBtnText.textContent = 'ยกเลิกแก้ไข';
            } else {
                titleIcon.className = 'fa-solid fa-file-pen mr-3 text-blue-600';
                titleText.textContent = 'สร้างข้อความแจ้งเตือน';
                submitBtnText.textContent = 'บันทึก';
                submitBtnIcon.className = 'fa-solid fa-paper-plane mr-2';
                submitBtn.classList.replace('bg-amber-500', 'bg-blue-600');
                submitBtn.classList.replace('hover:bg-amber-600', 'hover:bg-blue-700');
                clearBtnText.textContent = 'ล้างข้อมูล';
            }
        }

        function renderDashboard(allRows) {
            if (allRows.length === 0) {
                dashboard.innerHTML = '<div class="text-center py-8"><i class="fa-solid fa-folder-open text-4xl text-gray-300"></i><p class="text-gray-500 mt-4">ยังไม่มีข้อมูลในระบบ</p></div>';
                return;
            }
            
            const recentRows = allRows.slice().reverse().slice(0, 10); // Show last 10
            
            dashboard.innerHTML = '<div class="space-y-3">' + recentRows.map((row) => {
                const originalIndex = allRows.findIndex(r => r === row);
                const rowNumber = originalIndex + 2;

                const [date, phone, petName, appointmentType, timestamp] = [
                    row.c[0]?.v || 'N/A',
                    (row.c[1]?.v || 'N/A').replace(/'/g, ''),
                    row.c[2]?.v || 'N/A',
                    row.c[3]?.v || 'N/A',
                    row.c[4]?.v || null
                ];
                
                return `
                    <div class="dashboard-item border border-gray-200 rounded-xl p-4 transition-all hover:shadow-md hover:border-blue-500"
                         data-row-number="${rowNumber}" data-pet-name="${petName}" data-phone="${phone}"
                         data-appointment-type="${appointmentType}" data-send-date="${date}">
                        <div class="flex justify-between items-start">
                            <p class="font-bold text-lg text-gray-800">${petName}</p>
                            <div class="flex items-center space-x-2">
                                <button class="edit-btn action-btn text-gray-500 hover:text-blue-600" aria-label="Edit"><i class="fa-solid fa-pencil"></i></button>
                                <button class="delete-btn action-btn text-gray-500 hover:text-red-600" aria-label="Delete"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-2"><i class="fa-solid fa-syringe w-4 mr-1 text-gray-400"></i> ${appointmentType.split(' คำแนะนำ')[0]}</p>
                        <div class="flex text-sm text-gray-600 mt-1">
                            <p class="mr-4"><i class="fa-solid fa-mobile-screen-button w-4 mr-1 text-gray-400"></i> ${phone}</p>
                            <p><i class="fa-solid fa-calendar-days w-4 mr-1 text-gray-400"></i> ${date}</p>
                        </div>
                         <p class="text-xs text-right text-gray-400 mt-2">${formatRelativeTime(timestamp)}</p>
                    </div>
                `;
            }).join('') + '</div>';
        }

        // --- DATA FETCHING & ACTIONS ---
        async function loadDashboard() {
            try {
                // Add a cache-busting parameter to the URL to ensure fresh data is fetched.
                const response = await fetch(`${GVIZ_URL}&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                const text = await response.text();
                
                if (!text.startsWith('google.visualization.Query.setResponse')) {
                    console.error("Unexpected GVIZ response:", text);
                    throw new Error("Invalid GVIZ response format. Please check sheet sharing permissions.");
                }
                const jsonData = JSON.parse(text.substring(47, text.length - 2));

                if (!jsonData.table || !jsonData.table.rows) {
                    throw new Error("GVIZ response is valid JSON but lacks table data.");
                }
                
                renderDashboard(jsonData.table.rows);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                const errorHTML = `
                    <div class="text-center py-8 bg-red-50 p-4 rounded-lg border border-red-200">
                        <i class="fa-solid fa-circle-exclamation text-4xl text-red-500"></i>
                        <p class="text-red-700 mt-4 font-bold">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
                        <p class="text-red-600 mt-2 text-sm">${error.message}</p>
                        <p class="text-gray-600 mt-4 text-sm"><b>ข้อแนะนำ:</b> ปัญหานี้มักเกิดจาก Google Sheet ไม่ได้ตั้งค่าการแชร์เป็น "ทุกคนที่มีลิงก์" กรุณาตรวจสอบการตั้งค่าการแชร์ของชีทอีกครั้ง</p>
                    </div>
                `;
                dashboard.innerHTML = errorHTML;
            }
        }

        function enterEditMode(item) {
            appState.isEditing = true;
            appState.editingRowNumber = item.dataset.rowNumber;
            
            form.elements.petName.value = item.dataset.petName;
            form.elements.phoneNumber.value = item.dataset.phone;
            form.elements.appointmentType.value = item.dataset.appointmentType;
            form.elements.sendDate.value = convertBuddhistToGregorian(item.dataset.sendDate);

            updateFormUI();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function exitEditMode() {
            appState.isEditing = false;
            appState.editingRowNumber = null;
            form.reset();
            document.getElementById('sendDate').valueAsDate = new Date();
            updateFormUI();
        }

        function handleDelete(rowNumber) {
            Swal.fire({
                title: 'คุณแน่ใจหรือไม่?', text: "คุณต้องการลบข้อมูลนี้ใช่ไหม", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6',
                confirmButtonText: 'ใช่, ลบเลย!', cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    callAppsScript({ action: 'delete', rowNumber: rowNumber }, 'กำลังลบข้อมูล...');
                }
            });
        }

        function callAppsScript(data, loadingText) {
            Swal.fire({ title: loadingText, text: 'กรุณารอสักครู่...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const callbackName = 'jsonp_callback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                if (response.result === 'success') {
                    Swal.fire({ icon: 'success', title: 'สำเร็จ!', timer: 1500, showConfirmButton: false });
                    exitEditMode();
                    loadDashboard();
                } else {
                    handleError(new Error(response.error || 'Unknown error from server.'));
                }
            };

            const params = new URLSearchParams({ callback: callbackName, ...data });
            script.src = `${SCRIPT_URL}?${params.toString()}`;
            script.onerror = () => handleError(new Error('Network error: Failed to load the script.'));
            document.head.appendChild(script);
            
            setTimeout(() => {
                if (window[callbackName]) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    handleError(new Error('Request timed out. The server did not respond.'));
                }
            }, 15000); // 15 seconds timeout
        }

        function handleError(error) {
            console.error('Operation failed:', error);
            Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด!', text: error.message });
        }

        // --- EVENT LISTENERS ---
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const action = appState.isEditing ? 'update' : 'create';
            const loadingText = appState.isEditing ? 'กำลังอัปเดต...' : 'กำลังบันทึก...';
            
            const data = {
                action: action,
                sendDate: convertToBuddhistEra(form.elements.sendDate.value),
                phoneNumber: form.elements.phoneNumber.value,
                petName: form.elements.petName.value,
                appointmentType: form.elements.appointmentType.value,
                rowNumber: appState.editingRowNumber // Will be null if not editing
            };
            callAppsScript(data, loadingText);
        });

        document.getElementById('clearBtn').addEventListener('click', exitEditMode);
        document.getElementById('phoneNumber').addEventListener('input', (e) => e.target.value = e.target.value.replace(/[^0-9]/g, ''));
        dashboard.addEventListener('click', function(e) {
            const item = e.target.closest('.dashboard-item');
            if (!item) return;
            if (e.target.closest('.edit-btn')) enterEditMode(item);
            if (e.target.closest('.delete-btn')) handleDelete(item.dataset.rowNumber);
        });

        // --- INITIAL LOAD ---
        exitEditMode();
        loadDashboard();
    </script>
</body>
</html>
